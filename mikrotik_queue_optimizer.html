<!-- mikrotik_queue_optimizer.html -->
<section class="card">
  <h2 style="margin:0 0 10px">Mikrotik Queue Optimizer</h2>
  <p style="margin:0 0 12px;opacity:.8">PCQ auto generator (client-side)</p>
  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px">
    <div>
      <label class="label">Total Download (Mbps)</label>
      <input class="input" id="bwDown" type="number" placeholder="100" value="100" />
    </div>
    <div>
      <label class="label">Total Upload (Mbps)</label>
      <input class="input" id="bwUp" type="number" placeholder="50" value="50" />
    </div>
    <div>
      <label class="label">Active Users</label>
      <input class="input" id="users" type="number" placeholder="25" value="25" />
    </div>
    <div>
      <label class="label">Packet Size (bytes)</label>
      <input class="input" id="pkt" type="number" placeholder="1500" value="1500" />
    </div>
    <div>
      <label class="label">Delay (ms)</label>
      <input class="input" id="delay" type="number" placeholder="10" value="10" />
    </div>
    <div>
      <label class="label">Queue Priority (1-8)</label>
      <input class="input" id="prio" type="number" min="1" max="8" value="4" />
    </div>
  </div>
  <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
    <button class="btn" id="genBtn">Generate Script</button>
    <button class="btn" id="copyBtn" style="background:#0ea5e9">Copy</button>
  </div>
  <pre class="mono" id="out" style="white-space:pre-wrap;margin-top:12px"></pre>
</section>

<section class="card" style="margin-top:16px">
  <h3 style="margin:0 0 10px">Presets</h3>
  <div style="display:flex;gap:8px;flex-wrap:wrap">
    <input class="input" id="preset-name" placeholder="Preset name (e.g. 100M/50M 25 users)" style="max-width:340px">
    <button class="btn" id="preset-save">Save</button>
    <select class="input" id="preset-select" style="max-width:240px"></select>
    <button class="btn" id="preset-load" style="background:#10b981">Load</button>
    <button class="btn" id="preset-delete" style="background:#ef4444">Delete</button>
  </div>
</section>

<section class="card" style="margin-top:16px">
  <h3 style="margin:0 0 10px">Your IP & Location</h3>
  <div id="ipBox">Loading IP…</div>
</section>


<section class="card" style="margin-top:16px">
  <h3 style="margin:0 0 10px">Latency Tester</h3>
  <div style="display:flex;gap:8px;flex-wrap:wrap">
    <select class="input" id="lt-preset" style="max-width:260px"><option value="">--Preset Targets--</option><option value="https://1.1.1.1/">Cloudflare DNS (1.1.1.1)</option><option value="https://8.8.8.8/">Google DNS (8.8.8.8)</option><option value="https://94.140.14.14/">AdGuard DNS (94.140.14.14)</option><option value="https://94.140.15.15/">AdGuard DNS (94.140.15.15)</option><option value="https://dns.adguard-dns.com/">AdGuard DoH</option><option value="https://www.google.com/">Google</option><option value="https://cloudflare.com/">Cloudflare</option><option value="https://github.com/">GitHub</option></select><input class="input" id="lt-url" placeholder="https://1.1.1.1/" style="min-width:260px">
    <input class="input" id="lt-attempts" type="number" value="5" style="width:120px">
    <button class="btn" id="lt-run">Run</button>
  </div>
  <pre class="mono" id="lt-out" style="white-space:pre-wrap;margin-top:10px"></pre>
  <div style="margin-top:8px;opacity:.8">Tip: test requires internet & respects your Geolocation consent.</div>
</section>



<section class="card" style="margin-top:16px">
  <h3 style="margin:0 10px 10px 0;display:inline-block">Presets</h3>
  <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
    <select id="pz-list" class="input" style="max-width:220px"></select>
    <input id="pz-name" class="input" placeholder="Preset name" style="max-width:220px">
    <button class="btn" id="pz-save">Save</button>
    <button class="btn" id="pz-load" style="background:#6366f1">Load</button>
    <button class="btn" id="pz-del" style="background:#ef4444">Delete</button>
  </div>
</section>


<script type="module">
  import { calcPcq } from './modules/mikrotik/pcq.js';
  import { copyText, toast } from './modules/ui/copy.js';
  import { getPublicIP, getIPGeo } from './modules/net/ip.js';
  import { pingAvg, DEFAULT_TARGETS } from './modules/net/ping.js';
  import { listPresets, savePreset, loadPreset, deletePreset, serializeScope, applyScope } from './modules/ui/presets.js';

  const $ = (id)=>document.getElementById(id);

  async function showIP(){
    try{
      const ip = await getPublicIP();
      const geo = await getIPGeo(ip);
      $('ipBox').textContent = `IP: ${ip} — ${geo.city||'Unknown'}, ${geo.country_name||geo.country||''}`;
    }catch{ $('ipBox').textContent='Unable to fetch IP info'; }
  }
  try{
    if(localStorage.getItem('dmibot:consent_geo')==='true'){ showIP(); }
  }catch{}

  $('genBtn').addEventListener('click', ()=>{
    const down = parseFloat($('bwDown').value||'0');
    const up   = parseFloat($('bwUp').value||'0');
    const users= parseInt($('users').value||'1',10);
    const pkt  = parseInt($('pkt').value||'1500',10);
    const dly  = parseFloat($('delay').value||'10');
    const prio = Math.min(Math.max(parseInt($('prio').value||'4',10),1),8);

    if(!down||!up||!users){ toast('Isi bandwidth & users dengan benar'); return; }

    const { rateDown, rateUp, pcqLimit, pcqTotal } = calcPcq({ downMbps:down, upMbps:up, users, pktBytes:pkt, delayMs:dly });

    const script = `# ====== DMIBOT Queue Type Optimizer ======\n/queue type\nadd kind=pcq name=pcq-download pcq-classifier=dst-address \\\npcq-rate=${rateDown} pcq-limit=${pcqLimit} pcq-total-limit=${pcqTotal}\n\nadd kind=pcq name=pcq-upload pcq-classifier=src-address \\\npcq-rate=${rateUp} pcq-limit=${pcqLimit} pcq-total-limit=${pcqTotal}\n\n/queue tree\nadd name=Download parent=global queue=pcq-download priority=${prio}\nadd name=Upload parent=global queue=pcq-upload priority=${prio}\n# Notes: Total ${down}M/${up}M, Users ${users}, Pkt ${pkt}B, Delay ${dly}ms`;

    $('out').textContent = script;
  });



function respectConsent(){ try{ return localStorage.getItem('dmibot:consent_geo')==='true'; }catch{ return false; } }

async function initLatency(){
  const urlEl = $('lt-url');
  const attEl = $('lt-attempts');
  const out = $('lt-out');
  const btn = $('lt-run');
  if(!urlEl) return;

  urlEl.value = DEFAULT_TARGETS[0];

  btn.addEventListener('click', async()=>{
    out.textContent = '';
    if(!respectConsent()){ out.textContent = 'Denied by privacy setting. Enable Geolocation Consent in Settings.'; return; }
    const url = urlEl.value.trim();
    const n = Math.max(1, parseInt(attEl.value||'5',10));
    out.textContent = `Pinging ${url} x${n}...`;
    const r = await pingAvg(url, n, 2500);
    const lines = [];
    lines.push(`URL: ${r.url}`);
    lines.push(`Attempts: ${r.attempts}, Success: ${r.success}, Loss: ${r.loss.toFixed(0)}%`);
    if(r.avg!=null) lines.push(`Avg: ${r.avg.toFixed(1)} ms (min ${r.min.toFixed(1)} ms / max ${r.max.toFixed(1)} ms)`);
    out.textContent = lines.join('\n');
  });
}

function initPresets(){
  const KEY='queueOptimizer';
  const list = $('pz-list');
  const name = $('pz-name');
  const btnSave = $('pz-save');
  const btnLoad = $('pz-load');
  const btnDel = $('pz-del');
  if(!list) return;

  function refresh(){
    const items = listPresets(KEY);
    list.innerHTML = items.map(n=>`<option value="${n}">${n}</option>`).join('');
  }
  refresh();

  btnSave.addEventListener('click', ()=>{
    const nm = name.value.trim() || prompt('Preset name?');
    if(!nm) return;
    const data = serializeScope(document);
    savePreset(KEY, nm, data);
    refresh();
    name.value = nm;
    alert('Preset saved: '+nm);
  });

  btnLoad.addEventListener('click', ()=>{
    const nm = name.value.trim() || list.value;
    if(!nm){ alert('Select or type a preset name'); return; }
    const data = loadPreset(KEY, nm);
    if(!data){ alert('Preset not found'); return; }
    applyScope(data, document);
    alert('Loaded: '+nm);
  });

  btnDel.addEventListener('click', ()=>{
    const nm = name.value.trim() || list.value;
    if(!nm){ alert('Select or type a preset name'); return; }
    if(!confirm('Delete preset '+nm+'?')) return;
    deletePreset(KEY, nm);
    refresh();
    alert('Deleted: '+nm);
  });

  list.addEventListener('change', ()=>{ name.value = list.value; });
}

initLatency();
initPresets();

  $('copyBtn').addEventListener('click', async()=>{
    const t = $('out').textContent.trim();
    if(!t){ toast('Belum ada output'); return; }
    await copyText(t); toast('Script copied!');
  });
</script>
